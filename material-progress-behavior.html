<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">

<script>
(function() {
  'use strict';
  /**
   * `Polymer.MaterialProgressBehavior` is the base behavior for all `material-progress` elements.
   * It handles and optimize the measuring logic, and throttle rendering.
   *
   * @polymerBehavior Polymer.MaterialProgressBehavior
   */
  Polymer.MaterialProgressBehaviorImpl = {
    properties: {
      /**
       * Cached clientWidth of the inner container of the component
       */
      _clientWidth: {
        type: Number,
        value: undefined
      },

      /**
       * Cached clientHeight of the inner container of the component
       */
      _clientHeight: {
        type: Number,
        value: undefined
      }
    },

    listeners: {
      'iron-resize': '_onResize'
    },

    /**
     * Update and render the element.
     */
    update: function() {
      // Implemented in each component
    },

    /**
     * Pseudo getter for the inner container of all the SVGs
     */
    _getContainer: function() {
      // Implemented in each component
    },

    attached: function() {
      this._requestUpdate();
    },

    /**
     * Ensures to call (only once) the `update` function when the component is ready
     */
    _requestUpdate: function() {
      if (this._isReady || typeof this._getContainer().clientWidth !== 'undefined') {
        this._isReady = true;
        this.debounce('_doUpdate', this._doUpdate, 100);
      } else
        this.async(this._requestUpdate, 100);
    },

    /**
     * Calls the `update` function and cleans after itself!
     */
    _doUpdate: function() {
      // Measure if necessary
      if (this._needsMeasuring) {
        this._clientWidth = this._getContainer().clientWidth;
        this._clientHeight = this._getContainer().clientHeight;
        this._needsMeasuring = false;
      }

      // Call the component's `update` function
      this.update();

      // Remove a pentential `resizing` class
      this.async(function() {
        this._getContainer().classList.remove('resizing');
      }, 100);
    },

    /**
     * Resizing handler
     */
    _onResize: function() {
      // Set the `resizing` class to override CSS property if necessary
      this._getContainer().classList.add('resizing');
      // Trigger an update with measuring
      this._needsMeasuring = true;
      this._requestUpdate();
    }
  };

  /** @polymerBehavior */
  Polymer.MaterialProgressBehavior = [
    Polymer.IronResizableBehavior,
    Polymer.MaterialProgressBehaviorImpl
  ];
})();
</script>
